name: release

on:
  push:
    # Run on version tags
    tags:
      - "v[0-9]*"

jobs:
  build-compiler:
    timeout-minutes: 10
    strategy:
      matrix:
        include:
          - os: macos-26
            target: x86_64-apple-darwin
            compiler-exe: slicec-cs
          - os: macos-26
            target: aarch64-apple-darwin
            compiler-exe: slicec-cs
          - os: ubuntu-24.04
            target: x86_64-unknown-linux-gnu
            compiler-exe: slicec-cs
          - os: ubuntu-24.04
            target: aarch64-unknown-linux-gnu
            compiler-exe: slicec-cs
          - os: windows-2025
            target: x86_64-pc-windows-msvc
            compiler-exe: slicec-cs.exe
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build
        uses: ./.github/actions/build-compiler
        with:
          cargo-build-args: --release
          target: ${{ matrix.target }}
      - name: Sign slicec-cs compiler on Windows
        if: runner.os == 'Windows'
        uses: azure/trusted-signing-action@v0
        with:
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
          endpoint: https://eus.codesigning.azure.net/
          trusted-signing-account-name: zeroc
          certificate-profile-name: zeroc-ice
          files: tools/slicec-cs/target/${{ matrix.target }}/release/${{ matrix.compiler-exe }}
          file-digest: SHA256
          timestamp-rfc3161: http://timestamp.acs.microsoft.com
          timestamp-digest: SHA256
      - name: Archive Build
        uses: actions/upload-artifact@v4
        with:
          name: slicec-cs-${{ matrix.target }}
          path: tools/slicec-cs/target/${{ matrix.target }}/release/${{ matrix.compiler-exe }}
  build-packages:
    runs-on: windows-2025
    timeout-minutes: 10
    needs: build-compiler
    env:
      SLICEC_CS_STAGING_PATH: ${{ github.workspace }}\tools\slicec-cs\staging
    steps:
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x
      - uses: actions/checkout@v4
      - name: Download slicec-cs compiler artifacts
        uses: actions/download-artifact@v4
      - name: Set version from tag
        run: |
          $version = $env:GITHUB_REF -replace '^refs/tags/v',''
          echo "VERSION=$version" >> $env:GITHUB_ENV
      - name: Copy slicec-cs binaries to staging path
        run: |
          @("macos-x64", "macos-arm64", "linux-x64", "linux-arm64", "windows-x64") | ForEach-Object { New-Item -ItemType Directory -Path $env:GITHUB_WORKSPACE\tools\slicec-cs\staging -Name $_ }
          Copy-Item "slicec-cs-x86_64-apple-darwin\slicec-cs" -Destination "$env:GITHUB_WORKSPACE\tools\slicec-cs\staging\macos-x64"
          Copy-Item "slicec-cs-aarch64-apple-darwin\slicec-cs" -Destination "$env:GITHUB_WORKSPACE\tools\slicec-cs\staging\macos-arm64"
          Copy-Item "slicec-cs-x86_64-unknown-linux-gnu\slicec-cs" -Destination "$env:GITHUB_WORKSPACE\tools\slicec-cs\staging\linux-x64"
          Copy-Item "slicec-cs-aarch64-unknown-linux-gnu\slicec-cs" -Destination "$env:GITHUB_WORKSPACE\tools\slicec-cs\staging\linux-arm64"
          Copy-Item "slicec-cs-x86_64-pc-windows-msvc\slicec-cs.exe" -Destination "$env:GITHUB_WORKSPACE\tools\slicec-cs\staging\windows-x64"

          # Copy the compiler to the expected location to avoid rebuilding it when creating the NuGet packages
          New-Item -ItemType Directory -Path "$env:GITHUB_WORKSPACE\tools\slicec-cs\target\release"
          Copy-Item "slicec-cs-x86_64-pc-windows-msvc\slicec-cs.exe" -Destination "$env:GITHUB_WORKSPACE\tools\slicec-cs\target\release"
      - name: Build IceRPC Tools
        working-directory: tools
        run: dotnet build --configuration Release
      - name: Build IceRPC
        run: dotnet build --configuration Release
      - name: Pack IceRPC Tools
        working-directory: tools
        run: dotnet pack --configuration Release --output ../
      - name: Pack IceRPC
        run: dotnet pack --configuration Release --output .
      - name: Pack IceRPC Templates
        working-directory: src/IceRpc.Templates
        run: dotnet pack --configuration Release --output ../../
      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: packages
          path: |
            ./*.nupkg
            ./*.snupkg
  test-packages:
    timeout-minutes: 10
    strategy:
      matrix:
        include:
          - os: macos-26
          - os: ubuntu-24.04
          - os: windows-2025
    runs-on: ${{ matrix.os }}
    needs: build-packages
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            10.0.x
      - name: Initialize NuGet local cache
        run: dotnet restore
      - name: Download packages artifacts
        uses: actions/download-artifact@v4
        with:
          name: packages
          path: packages
      - name: Configure NuGet sources
        run: |
          dotnet new nugetconfig -o ${{ github.workspace }}
          dotnet nuget add source --configfile ${{ github.workspace }}/nuget.config -n "Local Packages" ${{ github.workspace }}/packages
        shell: pwsh
      - name: Install dotnet new templates
        working-directory: packages
        run: |
          $version = $env:GITHUB_REF -replace '^refs/tags/v',''
          dotnet new install IceRpc.Templates::$version
        shell: pwsh
      - name: ðŸ”¨ Build Examples
        run: |
          $examples = Get-ChildItem -Path examples -Recurse -Include *.sln
          foreach ($example in $examples) { dotnet build $example.FullName }
        shell: pwsh
      - name: ðŸ§ª Test Templates
        uses: ./.github/actions/test-templates
