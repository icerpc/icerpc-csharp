name: "Test NuGet Packages"

on:
  workflow_dispatch:
    inputs:
      channel:
        description: "The channel to publish to (e.g., stable, nightly)"
        required: true
      icerpc_version:
        description: "The IceRPC version to test for nightly releases"
        required: false
      run_id:
        description: "The run ID to use for downloading artifacts"
        required: true
  workflow_call:
    inputs:
      channel:
        required: true
        type: string
      icerpc_version:
        required: false
        type: string
      run_id:
        required: true
        type: string

jobs:
  test-packages:
    strategy:
      matrix:
        include:
          - os: macos-26
          - os: ubuntu-24.04
          - os: windows-2025
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x

      - name: Set IceRPC version
        run: |
          echo "ICERPC_VERSION=${{ inputs.icerpc_version }}" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Download NuGet artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_ID: ${{ inputs.run_id }}
        run: |
          mkdir packages -Force
          gh run download "$RUN_ID" --repo icerpc/icerpc-csharp --name "nuget-packages" --dir packages
        shell: pwsh

      - name: Configure NuGet sources
        run: |
          # Remove existing nuget.config to avoid conflicts
          rm -Force examples/nuget.config
          # Create a new nuget.config that points to the downloaded packages
          dotnet new nugetconfig -o ${{ github.workspace }}
          dotnet nuget add source --configfile ${{ github.workspace }}/nuget.config -n "Local Packages" ${{ github.workspace }}/packages
        shell: pwsh

      - name: Install dotnet new templates
        run: |
          $version = $env:ICERPC_VERSION
          dotnet new install IceRpc.Templates::$version
        shell: pwsh

      - name: ðŸ”¨ Build Examples
        run: |
          $examples = Get-ChildItem -Path examples -Recurse -Include *.slnx
          foreach ($example in $examples) { dotnet build $example.FullName /p:IceRpcVersion=$env:ICERPC_VERSION }
        shell: pwsh

      - name: ðŸ§ª Test Templates
        uses: ./.github/actions/test-templates
