name: Run Tests

runs:
  using: "composite"
  steps:
  - name: ðŸ§ª Test Slice Compiler
    run: cargo test --manifest-path tools/slicec-cs/Cargo.toml
    shell: bash

  - name: ðŸ§ª Test .NET
    run: |
      mkdir -p TestResults
      dotnet test \
        --no-build \
        --verbosity normal \
        --blame \
        --blame-crash \
        --blame-hang-timeout 300s \
        --diag:"TestResults/vstest.log" \
        --logger "trx;LogFileName=TestResults.trx" \
        --results-directory TestResults
    shell: bash

  - name: Install dotnet-trx tool
    run: dotnet tool install -g dotnet-trx
    shell: bash
    if: always()

  - name: Create test report
    run: trx --path TestResults
    shell: bash
    if: always()

  - name: Upload blame dumps and logs
    uses: actions/upload-artifact@v4
    if: failure()
    with:
      name: blame-and-dumps-${{ runner.os }}
      path: |
        TestResults/**/*.dmp
        TestResults/**/*.xml
        TestResults/**/*.txt
        TestResults/**/*.log
      if-no-files-found: ignore

  - name: Upload test results
    uses: actions/upload-artifact@v4
    with:
      name: test-results-${{ runner.os }}
      path: TestResults/*.trx
      if-no-files-found: ignore
    if: always()
